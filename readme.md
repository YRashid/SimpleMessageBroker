Процедура сборки
----------------

Перейти в корневую директорию проекта SimpleMessageBroker.
Выполнить в командной строке mvn test assembly:assembly.

API
---

**Добавление сообщения**:
GET/POST запрос на /publish. Обязательные параметры: topic - имя топика, message - текст сообщения.
Если код ответа 200, то сообщение принято и будет доставлено подписчикам.
Пример:
http://localhost:8080/publish?topic=temperature&message=39

**Подписка на новые сообщения в топике**:
GET/POST запрос на /subscribe. Обязательные параметры: topic - имя топика, subscriberName - имя подписчика, url - адрес куда отправлять новые сообщения.
Подписчик будет получать POST запросы на переданный url, в запросе будут переданы: массив message и соответствующий ему массив topic. Если подписчик принял сообщения, то он должен вернуть код 200. Иначе сообщения будут отправлены еще раз.
Пример:
http://localhost:8080/subscribe?subscriberName=bob&topic=temperature&url=http%3a%2f%2flocalhost%3a18080%2fsave
Новые сообщения будут отправлены на 
http://localhost:18080/save?message=39&topic=temperature&message=40&topic=temperature

Архитектура
-----------

**Класс Message:**
message - текст сообщения, topic - имя топика, date - дата приема сообщения сервлетом.

**Класс Subscriber:**
subscriberName - имя подписчика, topics - топики, на которые подписан подписчик, url - обратный адрес для новых сообщений.
messageQueue - очередь сообщений. Все сообщения подписчика хранятся в одной очереди.

**Класс SubscribersManage:**
subscribersList - список всех зарегистрированных подписчиков.
Метод addMessage(BackupTasks backupTasks, Message message) добавляет переданное сообщение в очереди сообщений тех подписчиков, кто подписан на топик этого сообщения. Если подписчики не успевают разгребать очередь (забилась память), то новые сообщения не принимаются, писателям отправляется ответ что сообщение не будет доставлено и просьбой попробовать позже с кодом 500. Также ставит задачу на запись сообщения в базу данных, для резервного копирования.

**Класс SendMessagesTimerTask:**
Раз в 3 секунды, проходится по очередям сообщений всех подписчиков, и если они имеют сообщения, то отправляет их. Если сообщения успешно доставлены, то помечает в бд, какое последнее сообщение было успешно доставлено. Лок для каждого подписчика нужен, чтобы при долгой отправке сообщений, эти же сообщения не добавились на отправку в другом потоке через следующие 3 секунды.

**Класс DBService:**
Управляет базой данных. Устанавливает соединение, сохраняет сообщения, подписчиков, топики, помечает последнее прочитанное сообщение в бд, создает таблицы. При запуске программы, загружает данные из бд в память. Данные - имена подписчиков, их топики, не отправленные сообщения.

**Класс BackupTasks:**
Ставит задачи записывающие данные в бд в поток.
Методы:
initSubscriber - добавить нового подписчика в бд
markLastSentMessage - пометить последнее переданное сообщение подписчика
addMessage - добавить новое сообщение всем читающим топик соответствующий сообщению.
addTopic - добавить новый топик подпичсику.

**Класс SubscribeServlet:**
Сервлет принимающий /subscribe запросы. Создает очередь сообщений для нового подписчика. Добавляет новый топик подписчику. Ставит задачу на добавление нового подписчика в бд.

**Класс PublishServlet:**
Сервлет принимающий /publish запросы. Добавляет переданное сообщение в очереди сообщений тех подписчиков, кто подписан на топик этого сообщения (т.е вызывает SubscribersManage#addMessage). При успешном добавлении возвращает код 200.

**Класс Main:**
Стартует при запуске проекта. Поднимает веб-сервер, на переданном порту (по умолчанию 8080). Инициализирует все необходимые классы, запускает таймер - выполняющий передачу новых сообщений подписчикам.

**Дополнительно:**
При запуске в первом аргументе можно передать порт, на который будут приходить http запросы. По умолчанию 8080.
Сообщения ограничены длинной 5000, url длинной 1024, имя подписчика 128 и имена топиков длинной 128 символов.
Запускать проект из директории библиотеки.
Лог пишется в файл smb_output.log в папке запуска проекта (описание логера в файле /src/main/resources/logback.xml).
Резервная копия сообщения пишется в файл backup.mv.db в папке запуска проекта (используется встроенная бд h2).
Запуск библиотеки java -jar ./simpleMessageBroker.jar.
